# =============================================================================
# Iris & Aegis - Nginx Location Blocks
# =============================================================================
# Included by nginx.conf for both HTTP and HTTPS servers
# =============================================================================

# Connection limits
limit_conn conn_limit 20;

# =============================================================================
# Aegis API Routes (/api/*)
# =============================================================================

location /api/ {
    # Rate limiting for API
    limit_req zone=api_limit burst=50 nodelay;

    # Proxy to Aegis backend
    proxy_pass http://aegis/api/;
    proxy_http_version 1.1;

    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # Error handling
    proxy_intercept_errors on;
    error_page 502 503 504 /50x.html;
}

# =============================================================================
# WebSocket Routes (/ws)
# =============================================================================

location /ws {
    # Rate limiting for WebSocket connections
    limit_req zone=ws_limit burst=5 nodelay;

    # Proxy to Aegis WebSocket
    proxy_pass http://aegis/ws;
    proxy_http_version 1.1;

    # WebSocket upgrade headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket-specific timeouts (longer for persistent connections)
    proxy_connect_timeout 60s;
    proxy_send_timeout 3600s;
    proxy_read_timeout 3600s;

    # Disable buffering for WebSocket
    proxy_buffering off;
    proxy_cache off;
}

# =============================================================================
# Socket.io Support (if using socket.io)
# =============================================================================

location /socket.io/ {
    # Rate limiting
    limit_req zone=ws_limit burst=10 nodelay;

    # Proxy to Aegis
    proxy_pass http://aegis/socket.io/;
    proxy_http_version 1.1;

    # WebSocket upgrade headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 3600s;
    proxy_read_timeout 3600s;

    # Disable buffering
    proxy_buffering off;
    proxy_cache off;
}

# =============================================================================
# Health Check Endpoint
# =============================================================================

location /health {
    access_log off;
    proxy_pass http://aegis/api/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}

# =============================================================================
# Iris Frontend (all other routes)
# =============================================================================

location / {
    # Proxy to Iris frontend
    proxy_pass http://iris;
    proxy_http_version 1.1;

    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support for Next.js HMR (development)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 8k;
}

# =============================================================================
# Next.js specific routes
# =============================================================================

# Next.js static files
location /_next/static/ {
    proxy_pass http://iris/_next/static/;
    proxy_http_version 1.1;

    # Cache static files
    proxy_cache_valid 200 60m;
    add_header Cache-Control "public, max-age=31536000, immutable";
}

# Next.js image optimization
location /_next/image {
    proxy_pass http://iris/_next/image;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}

# Next.js HMR WebSocket (development only)
location /_next/webpack-hmr {
    proxy_pass http://iris/_next/webpack-hmr;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 86400s;
}

# =============================================================================
# Static files and error pages
# =============================================================================

# Favicon
location = /favicon.ico {
    proxy_pass http://iris/favicon.ico;
    access_log off;
    log_not_found off;
}

# Robots.txt
location = /robots.txt {
    proxy_pass http://iris/robots.txt;
    access_log off;
    log_not_found off;
}

# Error pages
location = /50x.html {
    root /usr/share/nginx/html;
    internal;
}

# =============================================================================
# Security headers
# =============================================================================

# Add security headers to all responses
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# CORS headers (handled by Aegis, but can be set here as fallback)
# add_header Access-Control-Allow-Origin "http://localhost:3000" always;
# add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
# add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
