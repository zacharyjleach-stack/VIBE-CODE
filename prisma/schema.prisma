generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// COMMERCIAL MODELS - Token Sentry System
// ============================================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  name            String?
  avatarUrl       String?
  clerkId         String?   @unique  // Clerk user ID

  // Token Balance (The Micro-Trial)
  tokenBalance    Int       @default(5000)  // Start with 5,000 free tokens
  lifetimeLicense Boolean   @default(false) // Founder's License holders

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastActiveAt    DateTime?

  subscription    Subscription?
  tokenLedger     TokenLedger[]
  projects        Project[]
  apiKeys         ApiKey[]
}

model Subscription {
  id                  String    @id @default(uuid())
  userId              String    @unique

  // Stripe
  stripeCustomerId    String?   @unique
  stripeSubscriptionId String?  @unique
  stripePriceId       String?

  // Status
  status              String    @default("trialing") // trialing | active | cancelled | past_due | lifetime
  plan                String    @default("free") // free | pro | lifetime

  // Billing cycle
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean   @default(false)

  // Lifetime license
  lifetimePurchasedAt DateTime?
  lifetimeAmount      Int?      // Amount paid in cents ($550 = 55000)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TokenLedger {
  id          String   @id @default(uuid())
  userId      String

  // Transaction details
  type        String   // credit | debit
  action      String   // vibe_check | context_sync | agent_relay | signup_bonus | purchase | refund
  amount      Int      // Positive for credits, represents absolute value
  balanceAfter Int     // User's balance after this transaction

  // Metadata
  projectId   String?
  description String?
  metadata    String?  // JSON for additional data

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model ApiKey {
  id          String   @id @default(uuid())
  userId      String

  name        String
  keyHash     String   @unique  // Hashed API key (aegis_xxx)
  keyPrefix   String   // First 8 chars for display (aegis_ab12...)

  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isRevoked   Boolean  @default(false)

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================
// PROJECT MODELS (Existing)
// ============================================================

model Project {
  id          String   @id @default(uuid())
  userId      String?
  name        String
  path        String
  tier        String   @default("free")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User?    @relation(fields: [userId], references: [id])
  events      Event[]
  snapshots   Snapshot[]
  agents      AgentConfig[]

  @@unique([userId, path])
}

model Event {
  id          String   @id @default(uuid())
  projectId   String
  type        String
  agent       String?
  filePath    String?
  diff        String?
  summary     String?
  metadata    String?
  tokensUsed  Int      @default(0)
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
}

model Snapshot {
  id          String   @id @default(uuid())
  projectId   String
  stateJson   String
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AgentConfig {
  id          String   @id @default(uuid())
  projectId   String
  agentType   String
  configPath  String
  isActive    Boolean  @default(true)
  lastSync    DateTime?
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// ============================================================
// ANALYTICS
// ============================================================

model AnalyticsEvent {
  id          String   @id @default(uuid())
  userId      String?
  event       String   // page_view | download | signup | upgrade | vibe_check
  properties  String?  // JSON
  userAgent   String?
  ipHash      String?  // Hashed IP for privacy
  createdAt   DateTime @default(now())

  @@index([event, createdAt])
}
